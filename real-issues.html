<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width" />
<title>Real Issues - Gandaki Province</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h2 { text-align: center; }
  .chart-container { max-width: 600px; margin: auto; }
  canvas { max-width: 100%; }
  #sentimentChartContainer { display: none; margin-top: 40px; }
  .chart-title { text-align: center; font-weight: bold; margin-bottom: 10px; }
</style>
</head>
<body>
<h2>Real Issues in Gandaki Province</h2>

<div class="chart-container">
  <div>
    <div class="chart-title">Issues by Department (click a slice)</div>
    <canvas id="departmentChart"></canvas>
  </div>

  <div id="sentimentChartContainer">
    <div class="chart-title" id="sentimentTitle"></div>
    <canvas id="sentimentChart"></canvas>
  </div>
</div>

<script>
// Load CSV from same folder
async function loadCSV(url) {
  const res = await fetch(url);
  const text = await res.text();
  const lines = text.trim().split('\n');
  const rows = lines.slice(1).map(line => {
    const [feedback, department, sentiment] = line.split(',');
    return { feedback, department, sentiment };
  });
  return rows;
}

// Aggregate counts
function aggregateData(data) {
  const deptCounts = {};
  const deptSentiments = {};

  data.forEach(({department, sentiment}) => {
    deptCounts[department] = (deptCounts[department] || 0) + 1;
    if (!deptSentiments[department]) {
      deptSentiments[department] = { Positive: 0, Neutral: 0, Negative: 0 };
    }
    if (sentiment in deptSentiments[department]) {
      deptSentiments[department][sentiment]++;
    }
  });

  return { deptCounts, deptSentiments };
}

function randomColor() {
  return `hsl(${Math.floor(Math.random() * 360)}, 70%, 60%)`;
}

async function render() {
  const data = await loadCSV('feedback_summary_counts.csv');
  const { deptCounts, deptSentiments } = aggregateData(data);

  const departments = Object.keys(deptCounts);
  const counts = departments.map(d => deptCounts[d]);
  const colors = departments.map(() => randomColor());

  const ctxDept = document.getElementById('departmentChart').getContext('2d');
  let sentimentChart = null;

  const departmentChart = new Chart(ctxDept, {
    type: 'pie',
    data: {
      labels: departments,
      datasets: [{
        data: counts,
        backgroundColor: colors,
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' },
      },
      onClick(evt, activeEls) {
        if (!activeEls.length) return;
        const idx = activeEls[0].index;
        const dept = departments[idx];
        const sentiments = deptSentiments[dept];
        if (!sentiments) return;

        document.getElementById('sentimentTitle').textContent = `Sentiment Breakdown for "${dept}"`;
        document.getElementById('sentimentChartContainer').style.display = 'block';

        if (sentimentChart) sentimentChart.destroy();

        sentimentChart = new Chart(document.getElementById('sentimentChart').getContext('2d'), {
          type: 'pie',
          data: {
            labels: ['Positive', 'Neutral', 'Negative'],
            datasets: [{
              data: [sentiments.Positive, sentiments.Neutral, sentiments.Negative],
              backgroundColor: ['#4CAF50', '#FFC107', '#F44336'],
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
            }
          }
        });
      }
    }
  });
}

render();
</script>
</body>
</html>
